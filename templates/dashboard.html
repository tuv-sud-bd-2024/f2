{% extends "base.html" %}

{% block title %}Dashboard - DPDC OpenSTEF{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="bi bi-speedometer2"></i> Dashboard
</h1>

<div class="row">
    <!-- Daily Forecast Chart -->
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Daily Forecast vs Actual
            </div>
            <div class="card-body">
                <div id="dailyForecastChart"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Model Performance Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Model Performance Metrics
            </div>
            <div class="card-body">
                <div id="modelPerformanceChart"></div>
            </div>
        </div>
    </div>

    <!-- Hourly Pattern Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Average Hourly Load Pattern
            </div>
            <div class="card-body">
                <div id="hourlyPatternChart"></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Statistics Cards -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-lightning-charge-fill text-primary" style="font-size: 2.5rem;"></i>
                <h3 class="mt-3 mb-1" id="avgLoad">--</h3>
                <p class="text-muted mb-0">Average Load (MW)</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-arrow-up-circle-fill text-success" style="font-size: 2.5rem;"></i>
                <h3 class="mt-3 mb-1" id="peakLoad">--</h3>
                <p class="text-muted mb-0">Peak Load (MW)</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-percent text-info" style="font-size: 2.5rem;"></i>
                <h3 class="mt-3 mb-1" id="accuracy">--</h3>
                <p class="text-muted mb-0">Forecast Accuracy</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-graph-up-arrow text-warning" style="font-size: 2.5rem;"></i>
                <h3 class="mt-3 mb-1" id="r2Score">--</h3>
                <p class="text-muted mb-0">R² Score</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Load dashboard data on page load
    loadDashboardData();

    function loadDashboardData() {
        $('#loadingOverlay').show();

        fetch('/api/dashboard-data')
            .then(response => response.json())
            .then(data => {
                renderDailyForecastChart(data.daily_forecast);
                renderModelPerformanceChart(data.model_performance);
                renderHourlyPatternChart(data.hourly_pattern);
                updateStatistics(data);
                
                $('#loadingOverlay').hide();
            })
            .catch(error => {
                console.error('Error loading dashboard data:', error);
                $('#loadingOverlay').hide();
            });
    }

    function renderDailyForecastChart(data) {
        const traces = [
            {
                x: data.dates,
                y: data.actual,
                name: 'Actual',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#198754', width: 3 },
                marker: { size: 8 }
            },
            {
                x: data.dates,
                y: data.predicted,
                name: 'Predicted',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#667eea', width: 3, dash: 'dash' },
                marker: { size: 8 }
            }
        ];

        const layout = {
            title: 'Daily Load Forecast vs Actual',
            xaxis: {
                title: 'Date',
                tickangle: -45
            },
            yaxis: {
                title: 'Load (MW)'
            },
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                x: 0.02,
                y: 0.98,
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: '#ddd',
                borderwidth: 1
            },
            margin: { t: 50, b: 80, l: 60, r: 30 }
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false
        };

        Plotly.newPlot('dailyForecastChart', traces, layout, config);
    }

    function renderModelPerformanceChart(data) {
        const traces = [
            {
                x: data.models,
                y: data.mae,
                name: 'MAE',
                type: 'bar',
                marker: { color: '#667eea' }
            },
            {
                x: data.models,
                y: data.rmse,
                name: 'RMSE',
                type: 'bar',
                marker: { color: '#764ba2' }
            }
        ];

        const layout = {
            title: 'Model Error Metrics',
            xaxis: {
                title: 'Model'
            },
            yaxis: {
                title: 'Error Value'
            },
            barmode: 'group',
            showlegend: true,
            legend: {
                x: 0.02,
                y: 0.98,
                bgcolor: 'rgba(255, 255, 255, 0.8)',
                bordercolor: '#ddd',
                borderwidth: 1
            },
            margin: { t: 50, b: 50, l: 60, r: 30 }
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false
        };

        Plotly.newPlot('modelPerformanceChart', traces, layout, config);
    }

    function renderHourlyPatternChart(data) {
        const trace = {
            x: data.hours,
            y: data.avg_load,
            type: 'scatter',
            mode: 'lines+markers',
            fill: 'tozeroy',
            line: { color: '#0dcaf0', width: 3 },
            marker: { size: 6 },
            fillcolor: 'rgba(13, 202, 240, 0.2)'
        };

        const layout = {
            title: 'Average Load by Hour',
            xaxis: {
                title: 'Hour of Day',
                tickmode: 'linear',
                tick0: 0,
                dtick: 2
            },
            yaxis: {
                title: 'Average Load (MW)'
            },
            showlegend: false,
            margin: { t: 50, b: 50, l: 60, r: 30 }
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false
        };

        Plotly.newPlot('hourlyPatternChart', [trace], layout, config);
    }

    function updateStatistics(data) {
        // Calculate average load
        const avgLoad = (data.daily_forecast.actual.reduce((a, b) => a + b, 0) / 
                        data.daily_forecast.actual.length).toFixed(2);
        $('#avgLoad').text(avgLoad);

        // Calculate peak load
        const peakLoad = Math.max(...data.daily_forecast.actual).toFixed(2);
        $('#peakLoad').text(peakLoad);

        // Calculate accuracy (100 - MAPE)
        const actual = data.daily_forecast.actual;
        const predicted = data.daily_forecast.predicted;
        let mape = 0;
        for (let i = 0; i < actual.length; i++) {
            mape += Math.abs((actual[i] - predicted[i]) / actual[i]);
        }
        mape = (mape / actual.length) * 100;
        const accuracy = (100 - mape).toFixed(2);
        $('#accuracy').text(accuracy + '%');

        // Get best R² score
        const bestR2 = Math.max(...data.model_performance.r2).toFixed(3);
        $('#r2Score').text(bestR2);
    }
});
</script>
{% endblock %}

